(window.webpackJsonp=window.webpackJsonp||[]).push([[204],{726:function(t,a,s){"use strict";s.r(a);var e=s(14),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"文件上传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#文件上传"}},[t._v("#")]),t._v(" 文件上传")]),t._v(" "),s("blockquote",[s("p",[t._v("基础系列文章："),s("a",{attrs:{href:"https://segmentfault.com/a/1190000019940561",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://segmentfault.com/a/1190000019940561"),s("OutboundLink")],1)])]),t._v(" "),s("h3",{attrs:{id:"文件上传的三种方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#文件上传的三种方案"}},[t._v("#")]),t._v(" 文件上传的三种方案")]),t._v(" "),s("h4",{attrs:{id:"方案一-经典的-form-和-input-上传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#方案一-经典的-form-和-input-上传"}},[t._v("#")]),t._v(" 方案一：经典的 form 和 input 上传")]),t._v(" "),s("blockquote",[s("p",[t._v('设置 form 的 aciton 为后端页面，enctype="multipart/form-data"，type=‘post’')])]),t._v(" "),s("blockquote",[s("p",[t._v("form 表单提交操作网页会造成整体刷新")])]),t._v(" "),s("ul",[s("li",[t._v("优点：")])]),t._v(" "),s("blockquote",[s("p",[t._v("使用简单方便，兼容性好，基本所有浏览器都支持。")])]),t._v(" "),s("ul",[s("li",[s("p",[t._v("缺点：")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("提交数据后页面会跳转（ifrmae 可禁止页面跳转）。")])]),t._v(" "),s("li",[s("p",[t._v("因为是浏览器发起的请求，不是一个 ajax，所以前端无法知道什么时候上传结束。")])]),t._v(" "),s("li",[s("p",[t._v("form 表单里发送除文件外的数据，一般是新建一个 type=hidden 的 input，value=‘需要传的数据’，每发送一个数据就需要一个 input，一旦多了就会使得 dom 看起来比较冗余。")])])])])]),t._v(" "),s("h4",{attrs:{id:"方案二-使用-formdata-上传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#方案二-使用-formdata-上传"}},[t._v("#")]),t._v(" 方案二：使用 formData 上传")]),t._v(" "),s("blockquote",[s("p",[t._v("用 js 构造 form 表单的数据，简单高效，但最低只兼容 IE10，所以需要兼容 IE9 的童鞋们就略过这个方法吧。")])]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" formData "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FormData")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nformData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"userid"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" userid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nformData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"signature"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" signature"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nformData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"file"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" file"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//file是blob数据")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//再用ajax发送formData到服务器即可，注意一定要是post方式上传")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("ul",[s("li",[t._v("优点：")])]),t._v(" "),s("blockquote",[s("p",[t._v("由于这种方式是 ajax 上传，可以准确知道什么时候上传完成，也可以方便地接收到回调数据。")])]),t._v(" "),s("ul",[s("li",[t._v("缺点：")])]),t._v(" "),s("blockquote",[s("p",[t._v("兼容性差")])]),t._v(" "),s("h4",{attrs:{id:"方案三-使用-filereader-读取文件数据进行上传。"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#方案三-使用-filereader-读取文件数据进行上传。"}},[t._v("#")]),t._v(" 方案三：使用 fileReader 读取文件数据进行上传。")]),t._v(" "),s("blockquote",[s("p",[t._v("HTML5 的新 api，兼容性也不是特别好，只兼容到了 IE10。")])]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" fr "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FileReader")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nfr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("readAsDataURL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("file"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nfr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onload")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" data "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" event"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("result"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//此处获得的data是base64格式的数据")]),t._v("\n  img"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("src "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ajax")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" data "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("blockquote",[s("p",[t._v("上面获得的 data 可以用来实现图片上传前的本地预览，也可以用来发送 base64 数据给后端然后返回该数据块对应的地址。")])]),t._v(" "),s("ul",[s("li",[t._v("优点：")])]),t._v(" "),s("blockquote",[s("p",[t._v("可以准确知道什么时候上传完成，也可以方便地接收到回调数据。")])]),t._v(" "),s("ul",[s("li",[t._v("缺点：")])]),t._v(" "),s("blockquote",[s("p",[t._v("一次性发送大量的 base64 数据会导致浏览器卡顿，服务器端接收这样的数据可能也会出现问题。")])]),t._v(" "),s("h3",{attrs:{id:"文件上传格式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#文件上传格式"}},[t._v("#")]),t._v(" 文件上传格式")]),t._v(" "),s("h3",{attrs:{id:"文件上传基础"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#文件上传基础"}},[t._v("#")]),t._v(" 文件上传基础")]),t._v(" "),s("blockquote",[s("p",[t._v("onprogress 上传进度")])]),t._v(" "),s("blockquote",[s("p",[t._v("xhr.abort() 终止上传")])]),t._v(" "),s("h3",{attrs:{id:"拖拽上传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#拖拽上传"}},[t._v("#")]),t._v(" 拖拽上传")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("定义一个允许拖放文件的区域 div.drop-box")])]),t._v(" "),s("li",[s("p",[t._v("取消 drop 事件的默认行为 e.preventDefault();，不然浏览器会直接打开文件")])]),t._v(" "),s("li",[s("p",[t._v("为拖拽区域绑定事件,鼠标在拖拽区域上 dragover, 鼠标离开拖拽区域 dragleave, 在拖拽区域上释放文件 drop")])]),t._v(" "),s("li",[s("p",[t._v("drop 事件内获得文件信息 e.dataTransfer.files")])])]),t._v(" "),s("h3",{attrs:{id:"剪切板上传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#剪切板上传"}},[t._v("#")]),t._v(" 剪切板上传")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("页面内增加一个可编辑的编辑区域 div.editor-box,开启 contenteditable")])]),t._v(" "),s("li",[s("p",[t._v("为 div.editor-box 绑定 paste 事件")])]),t._v(" "),s("li",[s("p",[t._v("处理 paste 事件，从 event.clipboardData || window.clipboardData 获得数据")])]),t._v(" "),s("li",[s("p",[t._v("将数据转换为文件 items[i].getAsFile()")])]),t._v(" "),s("li",[s("p",[t._v("实现在编辑区域的光标处插入内容 insertNodeToEditor 方法")])])]),t._v(" "),s("h3",{attrs:{id:"多文件上传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#多文件上传"}},[t._v("#")]),t._v(" 多文件上传")]),t._v(" "),s("blockquote",[s("p",[t._v("input file 标签开启 multiple")])]),t._v(" "),s("h3",{attrs:{id:"大文件上传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#大文件上传"}},[t._v("#")]),t._v(" 大文件上传")]),t._v(" "),s("h4",{attrs:{id:"大文件上传满足条件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#大文件上传满足条件"}},[t._v("#")]),t._v(" 大文件上传满足条件")]),t._v(" "),s("ul",[s("li",[t._v("支持拆分上传请求(即切片上传)")]),t._v(" "),s("li",[t._v("支持断点续传")]),t._v(" "),s("li",[t._v("支持显示上传进度和暂停上传")])]),t._v(" "),s("h4",{attrs:{id:"大文件上传解决方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#大文件上传解决方案"}},[t._v("#")]),t._v(" 大文件上传解决方案")]),t._v(" "),s("ul",[s("li",[t._v("vue-simple-uploader 组件")])]),t._v(" "),s("blockquote",[s("p",[t._v("vue-simple-uploader 是基于 simple-uploader.js 封装的 vue 上传插件")])]),t._v(" "),s("blockquote",[s("p",[t._v("安装："),s("code",[t._v("npm install vue-simple-uploader --save")])])]),t._v(" "),s("blockquote",[s("p",[t._v("教程地址："),s("a",{attrs:{href:"https://www.cnblogs.com/xiahj/p/vue-simple-uploader.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.cnblogs.com/xiahj/p/vue-simple-uploader.html"),s("OutboundLink")],1)])]),t._v(" "),s("h4",{attrs:{id:"切片上传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#切片上传"}},[t._v("#")]),t._v(" 切片上传")]),t._v(" "),s("blockquote",[s("p",[t._v("编码方式上传中，在前端我们只要先获取文件的二进制内容，然后对其内容进行拆分，最后将每个切片上传到服务端即可。"),s("br"),t._v("\n在 JavaScript 中，文件 FIle 对象是 Blob 对象的子类，Blob 对象包含一个重要的方法 slice，通过这个方法，我们就可以对二进制文件进行拆分。")])]),t._v(" "),s("blockquote",[s("p",[t._v("实现步骤")])]),t._v(" "),s("ol",[s("li",[s("p",[t._v("把大文件进行分段（循环分解文件，依次创建文件切片） 比如 2M，发送到服务器携带一个标志，暂时用当前的时间戳，用于标识一个完整的文件")])]),t._v(" "),s("li",[s("p",[t._v("服务端保存各段文件")])]),t._v(" "),s("li",[s("p",[t._v("浏览器端所有分片上传完成，发送给服务端一个合并文件的请求")])]),t._v(" "),s("li",[s("p",[t._v("服务端根据文件标识、类型、各分片顺序进行文件合并")])]),t._v(" "),s("li",[s("p",[t._v("删除分片文件")])])]),t._v(" "),s("h4",{attrs:{id:"断点续传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#断点续传"}},[t._v("#")]),t._v(" 断点续传")]),t._v(" "),s("blockquote",[s("p",[t._v("断点续传：可以从已经上传部分开始继续上传未完成的部分，而没有必要从头开始上传，节省上传时间。")])]),t._v(" "),s("blockquote",[s("p",[t._v("解决了大文件上传超时和服务器的限制")])]),t._v(" "),s("blockquote",[s("p",[t._v("实现方案：")])]),t._v(" "),s("ul",[s("li",[t._v("为每个切片生成 hash 值，使用 spark-md5 库")]),t._v(" "),s("li",[t._v("在切片上传成功后，保存已上传的切片信息(前端：locaStorage，后端：接口保存，查询)")]),t._v(" "),s("li",[t._v("重新上传时，遍历切片列表，进行和本地分段 hash 值的对比，如果相同的话则跳过，继续下一个分段的上传(只选择未上传的切片进行上传,)")]),t._v(" "),s("li",[t._v("所有切片上传完毕后，再调用 mkfile 接口通知服务端进行文件合并")])]),t._v(" "),s("blockquote",[s("p",[t._v("问题：切片过期")])]),t._v(" "),s("h4",{attrs:{id:"秒传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#秒传"}},[t._v("#")]),t._v(" 秒传")]),t._v(" "),s("p",[t._v("原理：计算整个文件的 HASH，在执行上传操作前，向服务端发送请求，传递 MD5 值，后端进行文件检索。若服务器中已存在该文件，便不进行后续的任何操作，上传也便直接结束。")]),t._v(" "),s("h4",{attrs:{id:"hash-计算"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#hash-计算"}},[t._v("#")]),t._v(" Hash 计算")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("秒传，需要通过MD5值判断文件是否已存在。")])]),t._v(" "),s("li",[s("p",[t._v("续传：需要用到MD5作为key值，当唯一值使用。")])])]),t._v(" "),s("h2",{attrs:{id:"文件下载"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#文件下载"}},[t._v("#")]),t._v(" 文件下载")]),t._v(" "),s("h2",{attrs:{id:"文件夹上传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#文件夹上传"}},[t._v("#")]),t._v(" 文件夹上传")]),t._v(" "),s("h2",{attrs:{id:"其它"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#其它"}},[t._v("#")]),t._v(" 其它")]),t._v(" "),s("p",[t._v("作者：joker1148\n链接：https://www.nowcoder.com/discuss/610962?source_id=discuss_experience_nctrack&channel=-1\n来源：牛客网")]),t._v(" "),s("p",[t._v("所以就介绍了一下文件上传的过程\n问题：\n如何分片，为什么分 100 片\n除了分片还有什么其他的方法，有没有去了解过其他方法，有没有调研并比较过\n后端主要做了什么工作\n有没有在服务器和客户端都试了一遍")])])}),[],!1,null,null,null);a.default=n.exports}}]);